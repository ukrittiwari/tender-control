<!DOCTYPE html>
<!-- ========================================= -->
<!--   TENDER CONTROL SYSTEM - MAIN PAGE v1.1 -->
<!-- ========================================= -->
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tender Control System</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{background:#f4f6f9;padding:20px}
.card{border-radius:12px}
.stat{font-size:1.2rem;font-weight:bold}
.muted{color:#6c757d;font-size:.85rem}
.project-link{text-decoration:none;cursor:pointer}
.project-link:hover{text-decoration:underline}
.deadline-yellow{background:#fff3cd;color:#856404;font-weight:600;border-radius:6px;padding:2px 6px}
.deadline-orange{background:#ffe5b4;color:#8a4b08;font-weight:600;border-radius:6px;padding:2px 6px}
.deadline-red{background:#f8d7da;color:#842029;font-weight:700;border-radius:6px;padding:2px 6px}
.deadline-none{background:transparent}
</style>
</head>
<body style="display:none;">
<div class="container-fluid">
<!-- Top Header Bar -->
<div class="d-flex justify-content-end mb-3">
  <button id="logoutBtn" class="btn btn-sm btn-outline-danger">
    Logout
  </button>
</div>
<!-- KPI ROW 1 -->
<div class="row g-3 mb-3">
<div class="col-md-4"><div class="card p-3"><div class="muted">Total Projects</div><div id="kpiProjects" class="stat">0</div><div class="muted mt-1"><span id="kpiContractCount">0</span> Contract · <span id="kpiNonContractCount">0</span> No Contract</div></div></div>
<div class="col-md-4"><div class="card p-3"><div class="muted">Company Remaining Budget</div><div id="kpiCompanyBudget" class="stat">฿0 / ฿1,000,000</div><div class="progress mt-2" style="height:6px"><div id="kpiCompanyBudgetBar" class="progress-bar" style="width:100%"></div></div><div class="muted mt-1"><span id="kpiCompanyBudgetPct">100</span>% remaining</div></div></div>
<div class="col-md-4"><div class="card p-3"><div class="muted">Overall Project Budget</div><div id="kpiBudget" class="stat">฿0</div></div></div>
</div>

<!-- KPI ROW 2 -->
<div class="row g-3 mb-3">
<div class="col-md-4"><div class="card p-3"><div class="muted">Total Selling</div><div id="kpiSelling" class="stat">฿0</div></div></div>
<div class="col-md-4"><div class="card p-3"><div class="muted">Total Cost</div><div id="kpiCost" class="stat">฿0</div></div></div>
<div class="col-md-4"><div class="card p-3"><div class="muted">Total Profit</div><div id="kpiProfit" class="stat">฿0</div></div></div>
</div>

<!-- KPI ROW 3 -->
<div class="row g-3 mb-4">
<div class="col-md-4"><div class="card p-3"><div class="muted">Total Received Money</div><div id="kpiReceived" class="stat">฿0</div><div class="muted mt-1"><span id="kpiReceivedCount">0</span> projects completed</div></div></div>
<div class="col-md-4"><div class="card p-3"><div class="muted">Total Pending Amount</div><div id="kpiPending" class="stat">฿0</div><div class="muted mt-1"><span id="kpiPendingCount">0</span> active contract projects</div></div></div>
</div>

<!-- SEARCH / FILTER / ADD -->
<div class="d-flex justify-content-between align-items-center mb-3">
<div class="d-flex gap-2">
<input id="searchBox" class="form-control form-control-sm" style="width:220px" placeholder="Search ID or Alias">
<button class="btn btn-sm btn-outline-secondary" id="toggleFilters">Filters</button>
</div>
<button class="btn btn-sm btn-primary" id="toggleForm">+ Add Project</button>
</div>

<!-- FILTER PANEL -->
<div class="card p-3 mb-3" id="filterPanel" style="display:none">
<div class="row g-3">
<div class="col-md-4"><label class="form-label muted">Customer</label><select id="filterCustomer" class="form-select form-select-sm"><option value="">All</option><option>Railways</option><option>Port</option><option>Navy</option><option>Medical</option><option>Airport</option><option>Municipal</option><option>Airforce</option><option>Army</option></select></div>
<div class="col-md-4"><label class="form-label muted">Status</label><select id="filterStatus" class="form-select form-select-sm"><option value="">All</option><option>Announced</option><option>Submitted</option><option>L1</option><option>Negotiation</option><option>Order Placed</option><option>Pending Delivery</option><option>Delivered</option><option>Waiting Payment</option><option>Complete</option><option>Loss</option></select></div>
<div class="col-md-4"><label class="form-label muted">Contract</label><select id="filterContract" class="form-select form-select-sm"><option value="">All</option><option>Yes</option><option>No</option></select></div>
</div>
</div>

<!-- FORM -->
<div class="card p-3 mb-4" id="formPanel" style="display:none">
<h5>Add / Update Project</h5>
<div class="row g-3">
<div class="col-md-2"><label class="form-label">Tender ID</label><input id="tid" class="form-control" required></div>
<div class="col-md-3"><label class="form-label">Project Name</label><input id="pname" class="form-control" required></div>
<div class="col-md-2"><label class="form-label">Alias</label><input id="palias" class="form-control" required></div>
<div class="col-md-3"><label class="form-label">Customer</label><select id="customer" class="form-select" required><option value="">Select Customer</option><option>Railways</option><option>Port</option><option>Navy</option><option>Medical</option><option>Airport</option><option>Municipal</option><option>Airforce</option><option>Army</option></select></div>
<div class="col-md-2"><label class="form-label">Announced Date</label><input id="announceDate" type="date" class="form-control" required></div>
<div class="col-md-2"><label class="form-label">Submission Date</label><input id="submissionDate" type="date" class="form-control" required></div>
<div class="col-md-2"><label class="form-label">Project Budget</label><input id="budget" type="number" class="form-control" required></div>
<div class="col-md-2"><label class="form-label">Status</label><select id="status" class="form-select"><option>Announced</option><option>Submitted</option><option>L1</option><option>Negotiation</option><option>Order Placed</option><option>Pending Delivery</option><option>Delivered</option><option>Waiting Payment</option><option>Complete</option><option>Loss</option></select></div>
<div class="col-md-2"><label class="form-label">Contract</label><select id="contract" class="form-select"><option>Yes</option><option>No</option></select></div>
<div class="col-md-12 d-flex gap-2"><button class="btn btn-success" id="saveBtn">Save</button><button class="btn btn-outline-success" id="saveAddBtn">Save & Add Another</button><button class="btn btn-outline-secondary" id="clearBtn">Clear</button></div>
</div>
</div>

<!-- TABLE -->
<div class="card p-3">
<table class="table table-hover">
<thead><tr><th>ID</th><th>Project Name</th><th>Alias</th><th>Customer</th><th>Announced Date</th><th>Submission Date</th><th>Status</th><th>Contract</th><th>Actions</th></tr></thead>
<tbody id="tbody"></tbody>
</table>
</div>

</div>

<script type="module">
import { loadProjects, saveProject as saveProjectDB, deleteProjectDB, supabase } from './supabase.js';
let projectsChannel = null;
// ----------------------------------
// AUTH GUARD (CORRECT VERSION)
// ----------------------------------

const { data: { session } } = await supabase.auth.getSession();

if (!session) {
  window.location.replace('login.html');
}

// Watch auth state changes
supabase.auth.onAuthStateChange(async (event, session) => {

  if (!session) {
    window.location.replace('login.html');
    return;
  }

  // ---------- INITIAL DATA LOAD ----------
  const dbProjects = await loadProjects();
  tenders = dbProjects;
  render();

  // ---------- START REALTIME ----------
  if (projectsChannel) {
    supabase.removeChannel(projectsChannel);
  }

  projectsChannel = supabase
    .channel('projects-changes')
    .on(
      'postgres_changes',
      {
        event: '*',
        schema: 'public',
        table: 'projects'
      },
      async () => {
        const dbProjects = await loadProjects();
        tenders = dbProjects;
        render();
      }
    )
    .subscribe();

  // ---------- SHOW PAGE ----------
  document.body.style.display = 'block';
});
const COMPANY_BUDGET=1000000;

$('toggleForm').onclick=()=>$('formPanel').style.display=$('formPanel').style.display==='none'?'block':'none';
$('toggleFilters').onclick=()=>$('filterPanel').style.display=$('filterPanel').style.display==='none'?'block':'none';
$('saveBtn').onclick=()=>saveProject(false);
$('saveAddBtn').onclick=()=>saveProject(true);
$('clearBtn').onclick=clearForm;

function saveProject(keepOpen){
if(!validateForm())return;
const id=$('tid').value.trim();
let t=tenders.find(x=>x.id===id);
if(!t){t={costItems:[],totalCost:0};tenders.push(t);} 

t.id=id;
t.name=$('pname').value;
t.alias=$('palias').value;
t.customer=$('customer').value;
t.announceDate=$('announceDate').value;
t.submissionDate=$('submissionDate').value;
t.projectValue=Number($('budget').value)||0;
t.status=$('status').value;
t.contract=$('contract').value;
t.sellingValue=t.sellingValue??t.projectValue;

localStorage.setItem('tenders',JSON.stringify(tenders));
saveProjectDB(t);
clearForm();
if(!keepOpen)$('formPanel').style.display='none';
render();
}

function validateForm(){
if(!$('tid').value||!$('pname').value||!$('customer').value||!$('announceDate').value||!$('submissionDate').value||!$('budget').value){alert('Please complete all required fields');return false}
return true;
}

function clearForm(){['tid','pname','palias','announceDate','submissionDate','budget'].forEach(id=>$(id).value='');$('customer').value='';$('status').value='Announced';$('contract').value='No';}

function render(){
let tbAll=0,tcAll=0,tsAll=0,tpAll=0,receivedAll=0,pendingAll=0,receivedCount=0,pendingCount=0,ccAll=0,nccAll=0;

// KPI calculation
tenders.forEach(t=>{
const sell=t.sellingValue??t.projectValue??0;
const cost=t.totalCost||0;

tbAll+=t.projectValue||0;
tcAll+=cost;

if(t.contract==='Yes'){tsAll+=sell;tpAll+=sell-cost;ccAll++;}else{nccAll++;}
if(t.status==='Complete'){receivedAll+=sell;receivedCount++;}
if(t.contract==='Yes'&&t.status!=='Complete'){pendingAll+=sell;pendingCount++;}
});

const remAll=COMPANY_BUDGET-tcAll;
const pctAll=Math.max(0,Math.min(100,Math.round(remAll/COMPANY_BUDGET*100)));

$('kpiProjects').textContent=tenders.length;
$('kpiContractCount').textContent=ccAll;
$('kpiNonContractCount').textContent=nccAll;
$('kpiBudget').textContent='฿'+tbAll.toLocaleString();
$('kpiCost').textContent='฿'+tcAll.toLocaleString();
$('kpiSelling').textContent='฿'+tsAll.toLocaleString();
$('kpiProfit').textContent='฿'+tpAll.toLocaleString();
$('kpiReceived').textContent='฿'+receivedAll.toLocaleString();
$('kpiReceivedCount').textContent=receivedCount;
$('kpiPending').textContent='฿'+pendingAll.toLocaleString();
$('kpiPendingCount').textContent=pendingCount;
$('kpiCompanyBudget').textContent=`฿${remAll.toLocaleString()} / ฿${COMPANY_BUDGET.toLocaleString()}`;
$('kpiCompanyBudgetPct').textContent=pctAll;
$('kpiCompanyBudgetBar').style.width=pctAll+'%';
$('kpiCompanyBudgetBar').className='progress-bar '+(pctAll>50?'bg-success':pctAll>25?'bg-warning':'bg-danger');

const search=($('searchBox').value||'').toLowerCase();
const fc=$('filterCustomer').value;
const fs=$('filterStatus').value;
const fct=$('filterContract').value;

$('tbody').innerHTML='';

// TABLE RENDER
tenders.forEach(t=>{
if(search&&!(t.id.toLowerCase().includes(search)||(t.alias||'').toLowerCase().includes(search)))return;
if(fc&&t.customer!==fc)return;
if(fs&&t.status!==fs)return;
if(fct&&t.contract!==fct)return;

const today=new Date();
let deadlineClass='deadline-none';
if(t.submissionDate){
const subDate=new Date(t.submissionDate);
const todayOnly=new Date(today.getFullYear(),today.getMonth(),today.getDate());
const subOnly=new Date(subDate.getFullYear(),subDate.getMonth(),subDate.getDate());
const diffDays=Math.ceil((subOnly-todayOnly)/(1000*60*60*24));
if(diffDays===0)deadlineClass='deadline-red';
else if(diffDays>0&&diffDays<=2)deadlineClass='deadline-orange';
else if(diffDays>2&&diffDays<=5)deadlineClass='deadline-yellow';
}

$('tbody').insertAdjacentHTML('beforeend',`<tr>
<td>${t.id}</td>
<td><a class="project-link" href="project.html?id=${t.id}">${t.name}</a></td>
<td>${t.alias}</td>
<td>${t.customer}</td>
<td>${t.announceDate}</td>
<td><span class="${deadlineClass}">${t.submissionDate||''}</span></td>
<td><select class="form-select form-select-sm" onchange="updateStatus('${t.id}',this.value)">${['Announced','Submitted','L1','Negotiation','Order Placed','Pending Delivery','Delivered','Waiting Payment','Complete','Loss'].map(s=>`<option ${t.status===s?'selected':''}>${s}</option>`).join('')}</select></td>
<td><button class="btn btn-sm ${t.contract==='Yes'?'btn-success':'btn-outline-secondary'}" onclick="toggleContract('${t.id}')">${t.contract}</button></td>
<td><div class="dropdown"><button class="btn btn-sm btn-light" data-bs-toggle="dropdown">⋮</button><ul class="dropdown-menu dropdown-menu-end"><li><a class="dropdown-item" href="#" onclick="quickEdit('${t.id}')">Quick Edit</a></li>${t.contract==='Yes'?'':`<li><a class="dropdown-item text-danger" href="#" onclick="deleteProject('${t.id}')">Delete</a></li>`}</ul></div></td>
</tr>`);
});
}

async function updateStatus(id,v){
  const t=tenders.find(x=>x.id===id);
  if(!t) return;

  t.status=v;

  await saveProjectDB(t);

  localStorage.setItem('tenders',JSON.stringify(tenders));
  render();
}
async function toggleContract(id){
  const t=tenders.find(x=>x.id===id);
  if(!t) return;

  t.contract=t.contract==='Yes'?'No':'Yes';

  await saveProjectDB(t);

  localStorage.setItem('tenders',JSON.stringify(tenders));
  render();
}
function quickEdit(id){const t=tenders.find(x=>x.id===id);if(!t)return;$('formPanel').style.display='block';$('tid').value=t.id;$('pname').value=t.name;$('palias').value=t.alias;$('customer').value=t.customer;$('announceDate').value=t.announceDate;$('submissionDate').value=t.submissionDate||'';$('budget').value=t.projectValue;$('status').value=t.status;$('contract').value=t.contract;}
async function deleteProject(id){

 if(!confirm('Delete this project?')) return;

  await deleteProjectDB(id);

  tenders = tenders.filter(t=>t.id!==id);

  localStorage.setItem('tenders',JSON.stringify(tenders));

  render();
}
// expose functions globally for inline HTML handlers
window.updateStatus = updateStatus;
window.toggleContract = toggleContract;
window.quickEdit = quickEdit;
window.deleteProject = deleteProject;
['searchBox','filterCustomer','filterStatus','filterContract'].forEach(id=>$(id).oninput=render);
// Attach logout after DOM ready
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut();
  window.location.replace('login.html');
});

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
