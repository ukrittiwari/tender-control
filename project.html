<!DOCTYPE html>
<!-- ========================================= -->
<!--   TENDER CONTROL SYSTEM - CHILD PAGE v1  -->
<!--   OFFICIAL STABLE CHECKPOINT (CHILD)     -->
<!--   If user requests 'Revert to Child Page v1 Final', restore this exact file. -->
<!-- ========================================= -->
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Project Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background:#f4f6f9; padding:20px; }
.card { border-radius:12px; }
.stat { font-size:1.2rem; font-weight:bold; }
.muted { color:#6c757d; font-size:0.85rem; }
</style>
</head>
<body>
<div class="container-fluid">

<div class="mb-3 d-flex justify-content-between">
<button class="btn btn-sm btn-outline-secondary" onclick="window.location.href='index.html'">← Back</button>
<button class="btn btn-sm btn-success" id="saveProjectBtn">Save</button>
</div>

<div id="projectContainer" style="display:none;">
<div class="row g-3">

<!-- LEFT SIDE -->
<div class="col-md-8">
<div class="card p-4 mb-3">
<div id="projectTitle" class="stat"></div>
<div id="projectMeta" class="muted mb-3"></div>

<label class="form-label">Status</label>
<select id="projectStatus" class="form-select mb-3">
<option>Announced</option>
<option>Submitted</option>
<option>L1</option>
<option>Negotiation</option>
<option>Order Placed</option>
<option>Pending Delivery</option>
<option>Delivered</option>
<option>Waiting Payment</option>
<option>Complete</option>
<option>Loss</option>
</select>

<label class="form-label">Contract</label>
<select id="projectContract" class="form-select">
<option>Yes</option>
<option>No</option>
</select>
</div>

<div class="card p-4">
<h5>Cost Breakdown</h5>
<table class="table table-sm align-middle">
<thead>
<tr>
<th style="width:25%">Category</th>
<th>Description</th>
<th class="text-end" style="width:20%">Amount</th>
<th style="width:5%"></th>
</tr>
</thead>
<tbody id="costTableBody"></tbody>
<tfoot>
<tr class="fw-bold">
<td colspan="2" class="text-end">Total Cost</td>
<td class="text-end" id="totalCostCell">฿0</td>
<td></td>
</tr>
</tfoot>
</table>
<button class="btn btn-sm btn-outline-primary" id="addCostBtn">+ Add Cost</button>
</div>
</div>

<!-- RIGHT SIDE -->
<div class="col-md-4">
<div class="card p-3 mb-3">
<div class="muted">Project Budget</div>
<div id="kpiBudget" class="stat">฿0</div>
</div>

<div class="card p-3 mb-3">
<div class="muted">Selling Price</div>
<div id="kpiSelling" class="stat">฿0</div>
</div>

<div class="card p-3">
<div class="muted">Project Profit</div>
<div id="kpiProfit" class="stat">฿0</div>
</div>
</div>

</div>
</div>

<div id="notFound" class="alert alert-danger" style="display:none;">
Project not found. <a href="index.html">Return to main page</a>
</div>

</div>

<script>
const $ = id => document.getElementById(id);
const COST_CATEGORIES = ['Sample','Material','Shipping','Other'];

let tenders = JSON.parse(localStorage.getItem('tenders') || '[]');
let project = null;
let debounceTimer = null;

function getProjectId(){
return new URLSearchParams(window.location.search).get('id');
}

function formatCurrency(val){
return '฿' + (Number(val)||0).toLocaleString();
}

function loadProject(){
const id = getProjectId();
project = tenders.find(t=>t.id===id);

if(!project){
$('notFound').style.display='block';
return;
}

$('projectContainer').style.display='block';
$('projectTitle').textContent = project.name;
$('projectMeta').textContent = project.id + ' · ' + project.customer;
$('projectStatus').value = project.status;
$('projectContract').value = project.contract;

project.costItems = project.costItems || [];
renderCosts();
renderKPIs();
}

function renderCosts(){
const body = $('costTableBody');
body.innerHTML='';
let total=0;

project.costItems.forEach((item,index)=>{
total += item.amount || 0;

body.insertAdjacentHTML('beforeend',`
<tr>
<td>
<select class="form-select form-select-sm" onchange="updateCost(${index},'category',this.value)">
${COST_CATEGORIES.map(c=>`<option ${item.category===c?'selected':''}>${c}</option>`).join('')}
</select>
</td>
<td>
<input class="form-control form-control-sm" value="${item.description||''}" oninput="updateCost(${index},'description',this.value)">
</td>
<td>
<input type="number" class="form-control form-control-sm text-end" value="${item.amount||0}" oninput="updateCost(${index},'amount',this.value)">
</td>
<td>
<button class="btn btn-sm btn-outline-danger" onclick="removeCost(${index})">×</button>
</td>
</tr>`);
});

project.totalCost = total;
$('totalCostCell').textContent = formatCurrency(total);
renderKPIs();
}

function renderKPIs(){
const budget = project.projectValue || 0;
const selling = project.sellingValue ?? budget;
const cost = project.totalCost || 0;

$('kpiBudget').textContent = formatCurrency(budget);
$('kpiSelling').textContent = formatCurrency(selling);
$('kpiProfit').textContent = formatCurrency(selling - cost);
}

function updateCost(index,field,value){
if(field==='amount') value = Number(value)||0;
project.costItems[index][field]=value;

clearTimeout(debounceTimer);
debounceTimer=setTimeout(()=>{
renderCosts();
},800);
}

function removeCost(index){
project.costItems.splice(index,1);
renderCosts();
}

$('addCostBtn').onclick = ()=>{
project.costItems.push({category:'Material',description:'',amount:0});
renderCosts();
};

$('saveProjectBtn').onclick = ()=>{
project.status = $('projectStatus').value;
project.contract = $('projectContract').value;
localStorage.setItem('tenders',JSON.stringify(tenders));
alert('Project saved');
};

loadProject();
</script>
</body>
</html>
